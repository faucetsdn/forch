#!/bin/bash -e

ROOT=$(dirname $0)/..
cd $ROOT
local=
devices=
skip_conn_check=
no_clean=
faux_dhcp=
mode=bond

if [ "$1" == "local" ]; then
    local=local
    shift
fi

if [ "$1" == "devices" ]; then
    devices=y
    shift
fi

if [ "$1" == "skip-conn-check" ]; then
    skip_conn_check=y
    shift
fi

if [ "$1" == "dhcp" ]; then
    faux_dhcp=dhcp
    shift
fi

if [ "$1" == "no_clean" ]; then
    no_clean=y
    shift
fi

if [ -n "$1" ]; then
    mode=$1
    shift
fi

source bin/stack_functions

###########################################################

if [ -z "$no_clean" ]; then
    bin/net_clean
fi

echo Configuring mode $mode...

add_br corp  0x111 6683
add_br t1sw1 177 6001 7001
add_br t1sw2 178 6001 7001
add_br t2sw1 147058200627 6001 7001
add_br t2sw2 1296 6001 7001
add_br t2sw3 1297 6001 7001

add_oeth t1sw1 28 corp-eth10
add_oeth t1sw2 28 corp-eth20

add_link t1sw1 6 t1sw2 6

add_link t1sw1 9 t2sw1 50
add_link t1sw1 10 t2sw2 50
add_link t1sw1 11 t2sw3 50

add_link t1sw2 9 t2sw1 52
add_link t1sw2 10 t2sw2 52
add_link t1sw2 11 t2sw3 52

sudo ip link del bond || true
echo Setting up bond interface...
sudo ip link add bond type bond mode 802.3ad
sudo ip link set bond up
sudo ip link set corp-eth10 master bond
sudo ip link set corp-eth20 master bond
add_iface corp 10 bond

echo Starting faucet instances...
sudo rm -rf inst/
mkdir -p inst/forch-faucet-corp/faucet
cp topo/$mode/corp_conf.yaml inst/forch-faucet-corp/faucet/faucet.yaml
docker kill forch-faucet-corp || true
sudo modprobe bonding
bin/run_faucet $local corp 6683

for index in 1; do
    controller=forch-faucet-$index
    mkdir -p inst/$controller/
    cp -r topo/$mode/forch inst/$controller/
    cp -r topo/$mode/faucet inst/$controller/
    docker kill $controller || true
    bin/run_faucet $local $index $((6000 + index)) $((8000 + index))
    bin/run_faucet $local gauge $index $((7000 + index)) $((9000 + index))
done

echo Connecting faux interfaces
add_faux corp 1 0 dnsmasq
add_faux t2sw1 1 1
add_faux t2sw2 1 2
add_faux t2sw3 1 3 $faux_dhcp

if [ -n "$devices" ]; then
    for fnum in {4..44}; do
        add_faux t2sw1 $fnum $fnum
    done
fi

add_iface t1sw1 4 data_faucet_1

echo Letting system settle...
sleep 10

echo head of forch-faucet-1/faucet.log:
head inst/forch-faucet-1/faucet.log
echo

if [ -z "$skip_conn_check" ]; then
    echo Starting connection warm-up for 10s...
    docker exec forch-faux-0 ping -q -c 10 192.168.1.2 &
    docker exec forch-faux-1 ping -q -c 10 192.168.1.3 &
    docker exec forch-faux-2 ping -q -c 10 192.168.1.1 &
    docker exec forch-faux-3 ping -q -c 10 192.168.1.1 &

    echo Waiting for warm-ups to complete...
    wait

    echo Connection sanity check...
    docker exec forch-faux-0 ping -q -c 1 192.168.1.2
    docker exec forch-faux-1 ping -q -c 1 192.168.1.3
    docker exec forch-faux-2 ping -q -c 1 192.168.1.1
    docker exec forch-faux-3 ping -q -c 1 192.168.1.1
fi

echo Done with stack setup mode $mode.
