#!/bin/bash -e

setup_base=
faucet_port=6653
prom_port=9302

while [[ $# -gt 0 ]]; do
    case "$1" in
        -s|--setup_base)
            setup_base=y
            shift
            ;;
        -f|--faucet-port)
            faucet_port=$2
            shift
            shift
            ;;
        -p|--prometheus-port)
            prom_port=$2
            shift
            shift
            ;;
    esac
done

if [ -n "$setup_base" ]; then
    bin/setup_base
    bin/setup_faucet
    bin/build_docker ${DOCKER_BUILD:-pull}
fi

inst_dir=inst/forch-faucet-solo
mkdir -p $inst_dir/faucet
rm -rf $inst_dir/* || true
cp -r topo/solo/* $inst_dir/

bin/run_faucet local solo $faucet_port $prom_port

echo Killing any old instances of forch...
kill `ps ax | fgrep forchestrator | fgrep -v fgrep | awk '{print $1}'` || true
bin/forch --base inst/forch-faucet-solo 2>&1 &
sleep 20
