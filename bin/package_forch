#!/bin/bash -e

testing=

if [ "$1" == testing ]; then
    testing=$1
    shift
    git tag -d 0.0.0 || true
    git tag -a 0.0.0 -m "Testing"
fi

version=`git describe`

rm -rf dist/

python3 setup.py sdist bdist_wheel

#- apt-get update && apt-get upgrade -y
sudo apt-get install devscripts

sudo mk-build-deps -i -r -t 'apt-get -f -y'
#export DEBEMAIL='testuser@' && export DEBFULLNAME='Faucet Maintainers'
debchange --newversion $version -b "New upstream release"
dpkg-buildpackage -b -us -uc -rfakeroot
mv ../*.deb dist/

echo
ls -l dist/
echo
echo Created version $version '(from most recent annotated tag)'

if [ -n "$testing" ]; then
    echo Checking contents of generated debian package...
    dpkg -c dist/python3-forch_0.0.0_all.deb | fgrep forch/http_server.py
fi
