#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)
cd $ROOT

GIT_BRANCH=`git rev-parse --abbrev-ref HEAD`

GIT_REMOTE=`git config branch.$GIT_BRANCH.remote` || true
if [ -z "$GIT_REMOTE" ]; then
    GIT_URL=`git config remote.origin.url`
    GIT_REMOTE=tag
else
    GIT_URL=`git remote get-url $GIT_REMOTE`
fi

echo Build branch $GIT_BRANCH from $GIT_REMOTE at $GIT_URL
GIT_PEER=`echo $GIT_URL | sed s/forch/faucet/`
echo Auto-generated faucet git repo $GIT_PEER

FAUCET_REPO=$GIT_PEER
FAUCET_VERSION=$(cat etc/FAUCET_VERSION)

if [ -z "$VIRTUAL_ENV" ]; then
    python3 -m venv venv
    source venv/bin/activate
fi

SITE_PACKAGES_PATH=$(python3 -c 'import sysconfig; print(sysconfig.get_paths()["purelib"])')
rm -f $SITE_PACKAGES_PATH/faucet
ln -s $ROOT/faucet/faucet $SITE_PACKAGES_PATH/faucet

if [ -d faucet ]; then
    echo Dir faucet/ already exists. Not cloning.
else
    echo Cloning faucet locally...
    git clone $FAUCET_REPO faucet
    (cd faucet; git checkout $FAUCET_VERSION)
fi
