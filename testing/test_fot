#!/bin/bash -e

source bin/stack_functions

preamble_setup

function report_vlans {
    $YQ '.dps."nz-kiwi-t2sw1".interfaces."1".native_vlan' $BEHAVIORAL_CONFIG | tee -a $TEST_RESULTS
    $YQ '.dps."nz-kiwi-t2sw2".interfaces."1".native_vlan' $BEHAVIORAL_CONFIG | tee -a $TEST_RESULTS
}

INST_BASE=inst/forch-controller-1
DAQBASE=$INST_BASE/daq
FAUCET_BASE=$INST_BASE/faucet
BEHAVIORAL_CONFIG=$FAUCET_BASE/faucet.yaml
YQ=venv/bin/yq

echo DAQ spot checks

docker exec forch-faux-4 ping -c10 192.168.1.0

# Basic process startup.
fgrep "Loading base module config" $DAQBASE/inst/cmdrun.log

# Testing that python path is good.
ls -l $DAQBASE/inst/daq.pid

# Requires valid config available.
cat $DAQBASE/inst/daq_run_id.txt

# Requiring mininet path.
ls -l $DAQBASE/inst/dp_port_acls.yaml

# Check that OVS switch connects properly to managed faucet.
fgrep "System port 1 on dpid 1 is active True" $DAQBASE/inst/cmdrun.log

echo Done with daq startup tests.

# Forch startup checks
# Check Forch has successfuly started
fgrep -o "Starting Forchestrator" $INST_BASE/forch.log | tee -a $TEST_RESULTS

# Waiting for DAQ test to complete
monitor_daq_log "Setting port set 1 to vlan 272"
monitor_daq_log "Setting port set 2 to vlan 273"

docker exec forch-faux-1 ip addr show faux-eth0 | grep inet
docker exec forch-faux-2 ip addr show faux-eth0 | grep inet

vlan=$($YQ '.dps."nz-kiwi-t2sw1".interfaces."1".native_vlan' $BEHAVIORAL_CONFIG)
echo $(( (vlan > 271) + (vlan > 276) )) | tee -a $TEST_RESULTS
echo $(( (vlan > 271) + (vlan > 276) )) | tee -a $TEST_RESULTS

monitor_daq_log "Sending device result for device 9a:02:57:1e:8f:01: passed"
monitor_daq_log "Sending device result for device 9a:02:57:1e:8f:02: failed"
monitor_daq_log "Target device 9a02571e8f03 test hold running"

report_vlans

monitor_forch_log "Device 9a:02:57:1e:8f:03 is entering infracted state"
monitor_forch_log "Device 9a:02:57:1e:8f:04 is entering operational state from unauthenticated state"

docker stop forch-faux-3 # to cause an error so daq terminates
monitor_daq_log "Remaining target sets: []"

sequester_timeout=$(cat $INST_BASE/forch.log | grep "Device 9a:02:57:1e:8f:03 sequestering timedout" | wc -l)
echo Device sequestering timeout: $sequester_timeout | tee -a $TEST_RESULTS

cat $DAQBASE/inst/result.log | sort | tee -a $TEST_RESULTS
docker exec forch-faux-1 ping -c 5 192.168.1.0  > /dev/null # Make tests less flaky
docker exec forch-faux-1 ping -c 5 192.168.1.0 | fgrep "packet loss" | redact | tee -a $TEST_RESULTS
docker exec forch-faux-2 ping -c 5 192.168.1.0 | fgrep "packet loss" | redact | tee -a $TEST_RESULTS

